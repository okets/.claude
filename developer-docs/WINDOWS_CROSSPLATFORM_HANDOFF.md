# Windows Cross-Platform Support - Handoff Document

**Date:** December 30, 2025
**Author:** Windows Development Agent
**For:** macOS Development Agent

---

## Summary

Windows support has been added to smarter-claude. All changes were designed to preserve macOS/Linux behavior while adding Windows compatibility. This document explains what was changed and what you should verify on macOS.

---

## Changes Made

### 1. New Files Added

| File | Purpose |
|------|---------|
| `hooks/utils/audio_player.py` | Cross-platform audio playback |
| `hooks/utils/process_utils.py` | Cross-platform process management |
| `install.ps1` | Windows one-line installer |
| `setup.ps1` | Windows setup/configuration script |
| `update.ps1` | Windows update script |
| `statusline-command.ps1` | Windows status line for Claude Code |

### 2. Modified Files

| File | Changes |
|------|---------|
| `hooks/utils/tts/kokoro_voice.py` | Fixed temp file handling, replaced emojis with ASCII |
| `hooks/utils/tts/tts_controller.py` | Added import for audio_player |
| `hooks/utils/cycle_utils.py` | Changed `/tmp` to `tempfile.gettempdir()` |
| `hooks/stop.py` | Changed `/tmp` to `tempfile.gettempdir()` |
| `hooks/utils/notification_sounds.py` | Added audio_player import |
| `hooks/utils/settings.py` | Changed default TTS to `kokoro-am_puck` |
| `setup.sh` | Added `generate_settings_json()` function |
| `.gitignore` | Added `settings.json`, `.credentials.json` |

### 3. Removed Files

| File | Reason |
|------|--------|
| `settings.json` | Now generated by install scripts per-platform |
| `settings-windows.json` | Redundant - setup.ps1 generates settings directly |

---

## Key Technical Changes

### A. Audio Playback (`audio_player.py`)

**Pattern used:** ImportError fallback

```python
def play_audio_file(file_path, timeout=30):
    """Cross-platform audio playback"""
    if sys.platform == "darwin":
        # macOS: use afplay (original behavior preserved)
        subprocess.run(["afplay", file_path], check=True, timeout=timeout)
    elif sys.platform == "win32":
        # Windows: pygame -> winsound -> PowerShell fallback
        ...
    else:
        # Linux: aplay -> pygame fallback
        ...
```

**macOS behavior:** Unchanged - still uses `afplay`

### B. Process Management (`process_utils.py`)

**Pattern used:** Platform detection with identical macOS behavior

```python
def kill_process_by_name(process_name):
    if sys.platform == "win32":
        # Windows: use psutil
        ...
    else:
        # macOS/Linux: use pkill (EXACTLY as before)
        subprocess.run(["pkill", "-f", process_name], ...)
```

**macOS behavior:** Unchanged - still uses `pkill -f`

### C. Temp File Handling (`kokoro_voice.py`)

**Problem:** Windows locks temp files, causing errors with `delete=True`

**Solution:**
```python
# Old (broke on Windows):
with tempfile.NamedTemporaryFile(suffix='.wav', delete=True) as tmp_file:
    sf.write(tmp_file.name, samples, sample_rate)
    play_audio_file(tmp_file.name)

# New (works everywhere):
tmp_file = tempfile.NamedTemporaryFile(suffix='.wav', delete=False)
tmp_path = tmp_file.name
tmp_file.close()
try:
    sf.write(tmp_path, samples, sample_rate)
    play_audio_file(tmp_path)
finally:
    try:
        os.unlink(tmp_path)
    except:
        pass
```

**macOS impact:** Should work identically, just manual cleanup instead of auto-delete

### D. Temp Directory Paths

**Problem:** `/tmp` doesn't exist on Windows

**Solution:** Changed all `/tmp` references to `tempfile.gettempdir()`

```python
# Old:
debug_log = Path('/tmp/cycle_utils_debug.log')

# New:
import tempfile
debug_log = Path(tempfile.gettempdir()) / 'cycle_utils_debug.log'
```

**macOS result:** Returns `/var/folders/.../T/` or similar (standard macOS temp)

### E. Unicode/Emoji Encoding

**Problem:** Windows console (cp1252) can't encode emojis

**Solution:** Replaced all emojis with ASCII equivalents in hook output:
- `[OK]` instead of `‚úÖ`
- `[ERROR]` instead of `‚ùå`
- `[STREAM]` instead of `üîÑ`
- `[TTS]` instead of `üîä`
- etc.

**macOS impact:** Visual change only - ASCII works everywhere

### F. Settings Generation

**Old approach:**
- `settings.json` tracked in git with Unix paths
- Windows users had to copy `settings-windows.json` manually

**New approach:**
- `settings.json` in `.gitignore` (never tracked)
- `setup.sh` generates Unix paths: `~/.claude/hooks/...`
- `setup.ps1` generates Windows paths: `%USERPROFILE%\.claude\hooks\...`

**macOS impact:** `setup.sh` now has a `generate_settings_json()` function that creates settings.json

---

## What to Test on macOS

### Critical Tests

1. **TTS Still Works**
   ```bash
   cd ~/.claude/hooks/utils/tts
   uv run kokoro_voice.py kokoro-am_puck "Testing TTS on macOS"
   ```
   Expected: Audio plays, no errors

2. **Hooks Execute**
   - Start Claude Code in any project
   - Perform some actions
   - Verify TTS announcements work
   - Check that database is created: `ls .claude/smarter-claude/`

3. **Fresh Install**
   ```bash
   # Backup existing
   mv ~/.claude ~/.claude.backup

   # Fresh install
   curl -sSL https://raw.githubusercontent.com/okets/.claude/main/install.sh | bash

   # Verify settings.json was generated
   cat ~/.claude/settings.json | grep "~/.claude"
   ```
   Expected: Settings have Unix paths (`~/.claude/`)

4. **Audio Playback**
   ```bash
   cd ~/.claude
   python3 -c "from hooks.utils.audio_player import play_audio_file; play_audio_file('/System/Library/Sounds/Ping.aiff')"
   ```
   Expected: Ping sound plays (uses afplay)

5. **Process Killing**
   ```bash
   python3 -c "from hooks.utils.process_utils import kill_process_by_name; print('Import OK')"
   ```
   Expected: No import errors

### Regression Checks

1. **Temp files cleaned up** - After TTS, check no orphaned .wav files in temp dir
2. **Debug logs work** - Check `$TMPDIR/cycle_utils_debug.log` exists after hook runs
3. **No emoji in terminal output** - Hook output should show `[OK]`, `[ERROR]`, etc.

---

## Potential Issues to Watch

1. **`tempfile.gettempdir()` location** - On macOS this returns a user-specific temp folder, not `/tmp`. Should be fine but worth noting.

2. **afplay still used** - The `audio_player.py` explicitly checks for `darwin` and uses `afplay`. If this breaks, check the platform detection.

3. **setup.sh changes** - A new function `generate_settings_json()` was added. If settings.json isn't created on fresh install, check this function.

4. **Default voice changed** - Default TTS is now `kokoro-am_puck` instead of `macos-male`. This affects new installs only.

---

## Files You Probably Don't Need to Touch

These are Windows-only:
- `install.ps1`
- `setup.ps1`
- `update.ps1`
- `statusline-command.ps1`

---

## Questions?

If anything is broken on macOS, the issue is likely in:
1. `audio_player.py` - platform detection
2. `kokoro_voice.py` - temp file handling
3. `setup.sh` - settings generation

The goal was **zero changes to macOS behavior** - all platform-specific code uses explicit `sys.platform` checks with macOS as the default/original path.
